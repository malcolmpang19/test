name: CI/CD Pipeline for Main Branch

on:
  push:
    branches:
      - main

jobs:
  ci-pipeline:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the code
      - name: Check out the repository
        uses: actions/checkout@v3

      # Step 2: Run Super Linter
      - name: Run Super Linter
        uses: github/super-linter@v5
        env:
          DEFAULT_BRANCH: main
          VALIDATE_ALL_CODEBASE: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 3: Run Basic Tests
      - name: Run Smoke Tests
        run: |
          python3 -m http.server 8080 &
          sleep 2
          curl -I http://localhost:8080 || exit 1

      # Step 4: Perform Security Scan
      - name: Run Security Scan
        run: |
          npm install -g retire
          retire --path . --outputformat text || true

      # Step 5: Performance Benchmarking
      - name: Run Performance Benchmark
        run: |
          # Install Lighthouse
          npm install -g lighthouse
          # Run Lighthouse on the local server
          lighthouse http://localhost:8080 --output html --output-path ./lighthouse-report.html --only-categories=performance

      # Step 6: Upload Lighthouse Report as Artifact
      - name: Upload Lighthouse Performance Report
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-report
          path: ./lighthouse-report.html

  update-repo:
    runs-on: self-hosted

    steps:
      # Step 7: Check out the repository
      - name: Check out the repository
        uses: actions/checkout@v3

      # Step 8: Set correct permissions for the repository on the server
      - name: Set correct permissions for the repository
        run: |
          sudo chown -R $(whoami):$(whoami) /var/www/html/test
          sudo chmod -R u+rw /var/www/html/test

      # Step 9: Push updates to the RHEL server repository
      - name: Push updates to the RHEL server
        run: |
          cd /var/www/html/test
          git fetch origin main
          git reset --hard origin/main
          echo "Repository updated on the server."
